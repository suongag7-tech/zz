<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Noel ·∫§m √Åp üéÑ</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;overflow:hidden;font-family:'Times New Roman',serif;}
#canvas-container{width:100vw;height:100vh}

/* ‚ùÑÔ∏è Snow */
.snow{
 position:fixed;top:-10px;
 color:white;font-size:12px;
 opacity:.8;pointer-events:none;
 animation:fall linear infinite;
}
@keyframes fall{to{transform:translateY(110vh)}}

/* ‚ú® Intro */
#intro{
 position:fixed;inset:0;background:#000;
 display:flex;flex-direction:column;
 justify-content:center;align-items:center;
 z-index:20;
}
#intro h1{
 color:#fceea7;font-size:38px;
 letter-spacing:4px;
 opacity:0;animation:fadeIn 2s forwards;
}
#intro p{
 margin-top:12px;
 color:rgba(255,220,150,.8);
 opacity:0;animation:fadeIn 2s forwards 1s;
}
@keyframes fadeIn{to{opacity:1}}
.hide{opacity:0;pointer-events:none;transition:1.5s}

/* üéÅ Upload */
.upload{
 margin-top:14px;
 opacity:0;
 pointer-events:none;
 transition:1s;
}
.upload.show{
 opacity:1;
 pointer-events:auto;
}

#ui{
 position:absolute;top:0;width:100%;
 text-align:center;padding-top:30px;
 z-index:5;
}
h2{
 color:#fceea7;letter-spacing:3px;
 text-shadow:0 0 25px rgba(255,220,150,.6)
}
.upload label{
 padding:10px 22px;
 border:1px solid rgba(212,175,55,.5);
 color:#d4af37;font-size:11px;
 letter-spacing:3px;
}
.upload input{display:none}
.hint{font-size:10px;color:rgba(212,175,55,.5);margin-top:6px}
</style>

<script type="importmap">
{
 "imports":{
  "three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
  "three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
 }
}
</script>
</head>

<body>

<audio id="music" src="music.mp3" loop></audio>

<div id="intro">
  <h1>Merry Christmas</h1>
  <p>Ch·∫°m ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√©p m√†u üéÑ</p>
</div>

<div id="canvas-container"></div>

<div id="ui">
  <h2 id="mainWish"></h2>
  <div class="upload">
    <label>
      Th√™m ·∫£nh üéÅ
      <input type="file" id="file" accept="image/*" multiple>
    </label>
    <div class="hint">Ch·∫°m ƒë·ªÉ bung / gom c√¢y</div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

/* üëë TEXT */
const RECEIVER_NAME="C√¥ng ch√∫a nh·ªè";
const MAIN_WISH="Ch√∫c em m·ªôt m√πa Gi√°ng Sinh ·∫•m √°p v√† an y√™n ‚ú®";
document.getElementById("mainWish").innerText =
  RECEIVER_NAME+" ‚Äî "+MAIN_WISH;

/* üé∂ AUDIO */
let audioCtx, analyser, dataArray, audioStarted=false;

/* üéÑ THREE */
let scene,camera,renderer,composer,group,star;
let clock=new THREE.Clock();
let mode='TREE',items=[],treeLights=[];
let targetZoom=45;

init();snow();animate();

function init(){
 scene=new THREE.Scene();
 scene.fog=new THREE.FogExp2(0x000000,0.02);

 camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,0.1,200);
 camera.position.z=45;

 renderer=new THREE.WebGLRenderer({antialias:true});
 renderer.setSize(innerWidth,innerHeight);
 renderer.setPixelRatio(Math.min(devicePixelRatio,2));
 document.getElementById('canvas-container').appendChild(renderer.domElement);

 composer=new EffectComposer(renderer);
 composer.addPass(new RenderPass(scene,camera));
 composer.addPass(new UnrealBloomPass(
  new THREE.Vector2(innerWidth,innerHeight),.9,.4,.85
 ));

 group=new THREE.Group();scene.add(group);
 scene.add(new THREE.AmbientLight(0xffffff,.6));
 const p=new THREE.PointLight(0xffcc66,2,50);
 p.position.set(0,10,10);scene.add(p);

 createTree();
 createGarland();
 events();
}

function initAudio(){
 const audio=document.getElementById("music");
 audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 analyser=audioCtx.createAnalyser();
 analyser.fftSize=64;
 dataArray=new Uint8Array(analyser.frequencyBinCount);
 const src=audioCtx.createMediaElementSource(audio);
 src.connect(analyser);
 analyser.connect(audioCtx.destination);
}

/* üå≤ TREE */
function createTree(){
 const leafGeo=new THREE.ConeGeometry(0.32,1.2,8);
 const lightGeo=new THREE.SphereGeometry(.22,16,16);

 for(let i=0;i<1300;i++){
  const t=Math.random();
  const y=t*28-14;
  const r=(1-t)*9.8;
  const a=t*58*Math.PI;
  const isLight=Math.random()>0.72;

  let mat;
  if(isLight){
   mat=new THREE.MeshStandardMaterial({
    color:0xffe5a0,
    emissive:0xffcc66,
    emissiveIntensity:.6,
    roughness:.3,
    metalness:.6
   });
  }else{
   const c=new THREE.Color();
   c.setHSL(0.32-t*0.04,0.55+t*0.18,0.16+t*0.14);
   mat=new THREE.MeshStandardMaterial({
    color:c,roughness:.9,metalness:.05
   });
  }

  const geo=isLight?lightGeo:leafGeo;
  const m=new THREE.Mesh(geo,mat);
  m.position.set(Math.cos(a)*r,y,Math.sin(a)*r);
  group.add(m);

  if(isLight) treeLights.push(m);
  items.push({mesh:m,tree:m.position.clone(),scatter:randPos()});
 }

 const sGeo=new THREE.OctahedronGeometry(1.7);
 const sMat=new THREE.MeshStandardMaterial({
  color:0xffe9b0,
  emissive:0xffcc66,
  emissiveIntensity:1.6,
  roughness:.2,
  metalness:1
 });
 star=new THREE.Mesh(sGeo,sMat);
 star.position.set(0,15,0);
 group.add(star);
}

/* üéÄ GARLAND */
function createGarland(){
 const mat=new THREE.MeshStandardMaterial({
  color:0xffd27f,
  emissive:0xffc45c,
  emissiveIntensity:.6,
  metalness:1,
  roughness:.3
 });
 for(let i=0;i<7;i++){
  const geo=new THREE.TorusGeometry(6-i*0.6,.08,8,60);
  const g=new THREE.Mesh(geo,mat);
  g.rotation.x=Math.PI/2;
  g.position.y=8-i*2.6;
  group.add(g);
 }
}

function animate(){
 requestAnimationFrame(animate);
 const dt=clock.getDelta();
 group.rotation.y+=dt*.25;

 camera.position.z+=(targetZoom-camera.position.z)*dt*2;
 items.forEach(o=>{
  o.mesh.position.lerp(mode==='TREE'?o.tree:o.scatter,dt*2);
 });

 if(audioStarted){
  analyser.getByteFrequencyData(dataArray);
  const bass=dataArray[2]/255;
  treeLights.forEach(l=>{
   l.material.emissiveIntensity=.5+bass*1.5;
  });
  star.material.emissiveIntensity=1.3+bass*2.2;
  star.scale.setScalar(1+bass*.5);
 }

 composer.render();
}

function events(){
 addEventListener('click',()=>{
  document.getElementById("intro").classList.add("hide");
  document.getElementById("music").play();

  if(!audioStarted){
   initAudio();audioStarted=true;
  }

  document.querySelector(".upload").classList.add("show");

  mode=mode==='TREE'?'SCATTER':'TREE';
  targetZoom=mode==='TREE'?40:55;
 });
}

function snow(){
 setInterval(()=>{
  const s=document.createElement('div');
  s.className='snow';
  s.innerText='‚ùÑ';
  s.style.left=Math.random()*100+'vw';
  s.style.animationDuration=5+Math.random()*5+'s';
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),10000);
 },300);
}

function randPos(){
 const r=15+Math.random()*10;
 const a=Math.random()*Math.PI*2;
 const p=Math.acos(2*Math.random()-1);
 return new THREE.Vector3(
  r*Math.sin(p)*Math.cos(a),
  r*Math.sin(p)*Math.sin(a),
  r*Math.cos(p)
 );
}
</script>
</body>
</html>
